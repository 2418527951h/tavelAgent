# 旅游行程规划师 Agent 系统总体实现框架
该框架基于 LangChain 构建，以“需求理解→工具调用→结果整合→动态优化”为核心逻辑，整合 RAG 检索、Python 计算、可视化绘图、实时网络查询四大工具，结合领域微调模型与记忆模块，实现端到端的智能行程规划。


## 一、系统核心架构：五层模块化设计
整体架构分为 **用户交互层、Agent 决策层、工具调用层、数据存储层、输出展示层**，各层职责清晰、解耦设计，便于开发与迭代。

| 层级          | 核心功能                                                                 | 关键组件/技术                          |
|---------------|--------------------------------------------------------------------------|---------------------------------------|
| **用户交互层** | 接收用户需求（目的地、时间、预算、偏好），返回最终行程方案（文本+图表）  | 简单 Web 界面（Streamlit/Flask）、API 接口 |
| **Agent 决策层** | 核心“大脑”，负责需求解析、思考链推理、工具选择、多轮调用调度            | LangChain AgentExecutor、微调旅游领域模型 |
| **工具调用层** | 封装四大工具能力，接收 Agent 指令并返回执行结果                          | RAG 检索器、PythonREPL、Plotly/Matplotlib、SerpAPI |
| **数据存储层** | 存储行程规划所需的静态数据（景点库、攻略）、用户记忆数据、实时缓存数据    | VectorStore（RAG 用）、VectorStoreRetrieverMemory（记忆用）、Redis（实时数据缓存） |
| **输出展示层** | 将工具结果（文本、计算数据、图表）整合成结构化行程方案                   | Markdown 渲染、Plotly 图表嵌入、行程表生成器 |


## 二、核心模块详细设计
### 1. 用户交互层：轻量化需求输入与结果展示
目标是降低用户使用门槛，同时清晰呈现规划结果，优先选择 **Streamlit** 实现（开发效率高、支持图表嵌入）。
- **需求输入模块**：设计结构化表单，引导用户填写关键信息（必填项标红），示例如下：
  - 基础信息：目的地（如“成都”）、出行时间（如“2024.10.1-10.5”）、预算（如“5000元”）、同行人数（如“2人”）；
  - 偏好选择：旅行类型（自然风光/人文历史/美食探店）、交通偏好（地铁/打车/包车）、住宿偏好（经济型酒店/民宿）、忌口（如“不吃辣”）。
- **结果展示模块**：按“总览+每日详情”结构展示，支持交互操作：
  - 总览：行程摘要（总预算分配、核心景点清单、天气提醒）、景点分布地图（Plotly 交互式地图，标注景点位置与游览顺序）；
  - 每日详情：时间轴式行程表（如“09:00-11:00 大熊猫繁育研究基地”）、当日预算明细（门票+交通+餐饮）、实时提示（如“10.2 成都小雨，建议携带雨伞”）；
  - 交互功能：支持用户点击“调整预算”“替换景点”触发 Agent 二次优化。


### 2. Agent 决策层：思考链与工具调度核心
以 **LangChain AgentExecutor** 为框架，结合项目1微调的“旅游领域模型”作为推理核心，定义明确的思考链（Chain of Thought）逻辑，确保工具调用的合理性与高效性。

#### （1）核心组件
- **需求解析器（Prompt 工程）**：通过 Prompt 引导模型将用户自然语言需求转化为结构化任务，示例 Prompt 片段：
  > “请先解析用户需求：1. 提取目的地、时间、预算、人数；2. 识别旅行偏好（如自然风光/美食）；3. 明确潜在需求（如避开人流、亲子友好）。若有信息缺失，需询问用户补充。”
- **工具选择器（ToolSelector）**：基于解析后的任务，按规则匹配工具，规则示例：
  - 若需“景点推荐/攻略信息”→ 调用 RAG 检索工具；
  - 若需“预算拆分/时间计算”→ 调用 Python 解释器；
  - 若需“天气/实时交通”→ 调用网络工具（SerpAPI）；
  - 若需“行程可视化”→ 调用绘图工具（Plotly）。
- **多轮调度逻辑**：定义 Agent 迭代优化的触发条件，示例：
  1. 首次调用：先调用 RAG 检索目的地景点、美食、住宿数据，同时调用网络工具获取出行期间天气；
  2. 二次调用：基于 RAG 结果，用 Python 解释器计算“每日预算分配”“景点间交通时间”；
  3. 三次调用：用 Plotly 生成地图和行程表，若用户反馈“预算超支”，则重新调用 Python 解释器调整住宿/餐饮预算；
  4. 终止条件：行程方案满足“预算符合+时间合理+匹配偏好”，且无用户进一步调整需求。

#### （2）记忆模块集成
采用 **VectorStoreRetrieverMemory** 保存用户长期信息，避免重复输入，提升个性化程度：
- 存储内容：用户历史行程（如“2023年去过西安，偏好历史景点”）、偏好记录（如“不吃辣、不早起”）、预算敏感度（如“可接受10%预算浮动”）；
- 调用逻辑：Agent 每次推理前，先从记忆中读取用户历史数据，例如“用户曾偏好民宿，本次成都行程优先推荐民宿”。


### 3. 工具调用层：四大工具封装与适配
将工具统一封装为 LangChain 的 `Tool` 类，确保 Agent 可直接调用，每个工具需定义“输入参数格式”“输出结果格式”，避免数据格式不兼容。

#### （1）RAG 检索工具（景点/攻略检索）
- **数据来源**：提前爬取/整理公开旅游数据（如马蜂窝攻略、携程景点介绍、小红书美食推荐），按“目的地-景点/美食/住宿”分类；
- **技术实现**：
  1. 用 `LangChain` 的 `Chroma` 或 `FAISS` 作为 VectorStore，将旅游数据转换为向量存储；
  2. 封装 `RetrievalQA` 为 Tool，输入为“[目的地]+[需求类型]”（如“成都 亲子景点”），输出为“Top5 景点列表（含简介、门票、开放时间）”；
- **优化点**：加入“时效性过滤”，优先返回近1年的攻略（避免推荐已关闭的景点）。

#### （2）Python 解释器工具（计算功能）
- **核心计算场景**：
  - 预算拆分：输入“总预算5000元，5天，2人”，输出“每日预算1000元（门票300+餐饮400+交通150+住宿150）”；
  - 时间计算：输入“大熊猫基地（2h）→ 宽窄巷子（1.5h），两地距离8km”，输出“建议10:00出发，12:00结束熊猫基地，打车20分钟到宽窄巷子，12:30开始游览”；
- **技术实现**：
  1. 用 `LangChain` 的 `PythonREPL` 工具，限制代码执行范围（仅允许计算类代码，禁止文件操作）；
  2. 预设计算模板，例如预算拆分模板：
     ```python
     total_budget = 5000
     days = 5
     people = 2
     daily_budget = total_budget / days
     ticket_ratio = 0.3  # 门票占比30%
     food_ratio = 0.4    # 餐饮占比40%
     print(f"每日预算：{daily_budget}元，门票{daily_budget*ticket_ratio}元，餐饮{daily_budget*food_ratio}元")
     ```

#### （3）绘图工具（可视化功能）
- **核心图表类型**：
  1. 景点分布地图：用 `Plotly Express` 加载目的地地图，标注景点位置，用不同颜色区分“必去/备选”景点；
  2. 每日行程时间轴：用 `Plotly Bar` 或 `Timeline` 组件，x轴为时间（08:00-20:00），y轴为行程项（如“熊猫基地”），直观展示时间安排；
  3. 预算分配饼图：用 `Matplotlib` 展示“门票、餐饮、交通、住宿”的预算占比；
- **技术实现**：封装 `PlotlyTool`，输入为“数据字典”（如“{'景点':['熊猫基地','宽窄巷子'],'经度':[104.12,104.08],'纬度':[30.67,30.66]}”），输出为“图表HTML代码”（可直接嵌入 Streamlit 界面）。

#### （4）网络工具（实时信息获取）
- **核心获取场景**：
  - 实时天气：输入“成都 2024.10.1-10.5”，输出每日天气（晴/雨、气温、风力）；
  - 交通状况：输入“成都 大熊猫基地→宽窄巷子 10.1 09:00”，输出“早高峰可能拥堵，建议提前30分钟出发”；
  - 景点实时人流：输入“成都 大熊猫基地 10.1”，输出“预计人流高峰10:00-12:00，建议9:00前到达”；
- **技术实现**：
  1. 调用 `SerpAPI`（Google 搜索API）或国内“百度搜索API”，封装为 LangChain 的 `SerpAPIQueryRun` Tool；
  2. 定义查询模板，例如天气查询模板：“{目的地} {日期} 天气 温度 降水概率”，确保返回结构化数据（用正则表达式提取“天气、气温、降水”）。


### 4. 数据存储层：结构化与非结构化数据管理
- **RAG 向量库**：用 `Chroma` 存储旅游攻略、景点信息等非结构化文本的向量，支持快速检索；
- **用户记忆库**：同 `VectorStoreRetrieverMemory`，与 RAG 向量库共用 `Chroma` 实例（按“数据类型”分区）；
- **实时数据缓存**：用 `Redis` 缓存近1小时内的天气、交通数据，避免重复调用 API（降低成本、提升速度），缓存过期时间设为1小时（确保数据新鲜）；
- **行程方案存储**：将生成的最终行程（文本+图表链接）用 `SQLite` 存储，支持用户“再次查看历史行程”。


### 5. 输出展示层：结构化行程方案生成
Agent 完成所有工具调用后，将“RAG 景点信息、Python 计算结果、Plotly 图表”整合为 **Markdown 格式的结构化行程方案**，示例如下：
```markdown
# 成都5日游行程规划（2024.10.1-10.5，预算5000元/2人）
## 行程总览
- 核心景点：大熊猫繁育研究基地、宽窄巷子、锦里、都江堰、青城山
- 总预算分配：门票1500元（30%）、餐饮2000元（40%）、交通750元（15%）、住宿750元（15%）
- 天气提醒：10.2小雨（带雨伞），10.3-10.5晴（适合户外游览）

## 每日详情（10.1 第一天）
| 时间       | 行程项               | 详情                                  | 预算   |
|------------|----------------------|---------------------------------------|--------|
| 09:00-11:30 | 大熊猫繁育研究基地   | 建议早到，看熊猫进食；门票55元/人     | 110元  |
| 12:00-13:30 | 午餐（蜀大侠火锅）   | 距离熊猫基地5km，打车20分钟；人均80元 | 160元  |
| 14:30-16:30 | 宽窄巷子             | 免费，逛文创店、喝茶；交通打车15元    | 15元   |

## 可视化图表
- 景点分布地图：[Plotly 交互式地图链接]
- 每日预算饼图：[Matplotlib 图表链接]
```


## 三、开发与部署流程（分阶段实现）
### 阶段1：基础工具封装（1-2周）
1. 搭建 RAG 检索系统：爬取/导入成都、西安等热门城市的旅游数据，用 Chroma 构建向量库，测试检索准确性；
2. 封装 PythonREPL、Plotly、SerpAPI 工具，确保单个工具可独立调用（如输入“计算5000元5天预算”，Python 解释器返回正确结果）。

### 阶段2：Agent 决策逻辑开发（1-2周）
1. 基于 LangChain AgentExecutor，编写需求解析 Prompt 和工具选择规则；
2. 集成记忆模块，测试“用户偏好记忆”功能（如用户首次输入“不吃辣”，后续行程自动避开辣菜餐厅）；
3. 调试多轮调用逻辑，确保 Agent 能根据工具结果迭代优化（如预算超支时自动下调住宿标准）。

### 阶段3：用户交互层与输出整合（1周）
1. 用 Streamlit 开发前端界面：设计需求输入表单、行程结果展示页面；
2. 实现“图表嵌入”功能：将 Plotly 图表HTML代码直接渲染到 Streamlit 中；
3. 测试端到端流程：用户输入需求→Agent 调用工具→生成行程方案，验证全链路通顺。

### 阶段4：测试与优化（1周）
1. 功能测试：覆盖“预算计算错误”“景点信息过时”“天气数据不更新”等异常场景；
2. 性能优化：调整 RAG 检索TopK数量（如从10降到5，提升速度）、优化 Redis 缓存策略；
3. 体验优化：补充“行程调整按钮”（如用户点击“替换景点”，Agent 重新推荐同类景点）。


## 四、关键技术难点与解决方案
| 技术难点                | 解决方案                                                                 |
|-------------------------|--------------------------------------------------------------------------|
| RAG 检索结果不准确      | 1. 优化嵌入模型（用旅游领域微调的 Embedding 模型，如 BERT-旅游版）；2. 加入关键词过滤（如检索“成都亲子景点”时，过滤掉“成人夜游”类结果） |
| Python 解释器执行风险    | 1. 限制代码执行范围（禁止 `os`/`sys` 模块）；2. 预设计算模板，仅允许填充参数，不允许自定义代码 |
| 实时数据获取失败（API 宕机） | 1. 缓存历史数据（如前1小时的天气），作为备用；2. 加入降级策略（API 失败时，提示“当前实时数据不可用，使用历史平均数据”） |
| Agent 多轮调用陷入死循环 | 1. 设置最大调用次数（如最多调用5次）；2. 定义“终止条件”（如预算误差<5%、行程时间无冲突则终止） |


通过以上框架，可快速实现“旅游行程规划师 Agent”的核心功能，同时保留扩展性（后续可新增“机票/酒店预订接口”“语音交互”等功能）。